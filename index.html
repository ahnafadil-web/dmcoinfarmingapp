<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DM COIN FARMING ‚Äî Task Redirect + Mining Fixed</title>
<style>
:root{
  --bg:#0f0f11; --surface:#171718; --muted:#9aa0a6; --accent:#0a84ff;
  --success:#4caf50; --danger:#f44336; --card:#1f1f22;
  --font:"Inter",system-ui,Arial,sans-serif;
}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font);background:var(--bg);color:#fff;min-height:100vh;display:flex;flex-direction:column}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--surface);border-bottom:1px solid #222}
.balance{font-weight:700;font-size:1.1rem}
.small{color:var(--muted);font-size:0.85rem}
main{flex:1;overflow:auto;padding:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.center{text-align:center}
.logo{width:110px;height:110px;border-radius:50%;display:block;margin:0 auto 10px;border:4px solid var(--accent);object-fit:cover}
.progress-wrap{background:#111;border-radius:10px;padding:4px}
.progress{height:10px;border-radius:8px;background:var(--success);width:0%;transition:width 0.3s linear}
button{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer}
button.small{padding:4px 8px;font-size:0.8rem;margin:0 2px}
.nav{display:flex;gap:8px;justify-content:space-around;background:var(--surface);padding:10px;border-top:1px solid #222;position:sticky;bottom:0}
.nav button{flex:1;border-radius:8px;font-size:0.9rem}
.hidden{display:none}
.task-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--card);margin-bottom:8px}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-top:8px}
.muted{color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:8px}
th,td{border-bottom:1px solid rgba(255,255,255,0.06);padding:6px;text-align:left}
th{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div>
    <div class="balance" id="coinBalance">üí∞ 0</div>
    <div class="small" id="farmStatus">Ready</div>
  </div>
  <div style="text-align:right">
    <div id="userName">User</div>
    <div class="small" id="userId">ID: -</div>
  </div>
</header>

<main>
  <section id="farmTab" class="card center">
    <img class="logo" src="https://i.ibb.co/04PQkwb/IMG-3086.png" alt="logo">
    <h2>DM COIN FARMING</h2>
    <div class="progress-wrap" style="width:90%;margin:12px auto 8px">
      <div class="progress" id="farmProgress"></div>
    </div>
    <div id="farmTimer" class="muted">Ready to farm!</div>
    <div style="margin-top:10px"><button id="farmButton">Start Mining</button></div>
  </section>

  <section id="tasksTab" class="card hidden">
    <h3>Tasks</h3>
    <div id="taskList"></div>
  </section>

  <section id="referralTab" class="card hidden">
    <h3>Referral</h3>
    <p>Your referral link:</p>
    <input readonly id="refLink">
    <button onclick="copyRef()">Copy Link</button>
    <p class="muted" style="margin-top:10px">Invite friends & earn 500 coins each!</p>
    <div style="margin-top:10px" id="refInfo" class="muted">No referrals yet.</div>
  </section>

  <section id="exchangeTab" class="card hidden">
    <h3>Exchange & Withdraw</h3>
    <input id="convertAmount" type="number" placeholder="Coins to convert">
    <button onclick="convertCoins()">Convert</button>
    <div id="convertedResult" class="muted" style="margin-top:6px"></div>
    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
    <h4>Withdraw</h4>
    <input id="withdrawAmount" type="number" placeholder="Amount">
    <select id="withdrawMethod"><option value="sol">Solana</option><option value="dm">DM Coin</option></select>
    <input id="withdrawAddress" placeholder="Address">
    <button onclick="requestWithdraw()">Request Withdraw</button>
    <div style="margin-top:12px"><h4>History</h4><div id="withdrawList" class="muted">No history yet.</div></div>
  </section>

  <section id="profileTab" class="card hidden">
    <h3>Profile</h3>
    <div class="task-item"><div>User ID</div><div id="profileUserId">-</div></div>
    <div class="task-item"><div>Total Coins</div><div id="profileCoins">0</div></div>
    <div class="task-item"><div>Completed Tasks</div><div id="profileCompleted">0</div></div>
  </section>

  <section id="adminTab" class="card hidden">
    <h3>Admin</h3>
    <input id="adminEmail" placeholder="email">
    <input id="adminPass" type="password" placeholder="password">
    <button onclick="adminLogin()">Login</button>
    <div id="adminPanel" class="hidden" style="margin-top:12px">
      <h4>Add Task</h4>
      <input id="taskTitle" placeholder="Task Title">
      <input id="taskReward" type="number" placeholder="Reward (coins)">
      <input id="taskLink" placeholder="Task Link (URL)">
      <button onclick="addTask()">Add Task</button>
      <div id="adminTaskList"></div>
      <hr><h4>User Withdraw Requests</h4><div id="adminWithdrawList" class="muted">No withdrawals yet.</div>
    </div>
  </section>
</main>

<nav class="nav">
  <button data-tab="farmTab">üè† Farm</button>
  <button data-tab="tasksTab">üìã Tasks</button>
  <button data-tab="referralTab">ü§ù Refer</button>
  <button data-tab="exchangeTab">üí∏ Exchange</button>
  <button data-tab="profileTab">üë§ Profile</button>
  <button data-tab="adminTab">‚öôÔ∏è Admin</button>
</nav>

<script>
const DEFAULTS={farmRate:100,farmingDurationMs:24*60*60*1000,coinToUsd:0.01};
const ADMIN={email:"ahnafadilbsja@gmail.com",pass:"dmcoin2025"};
let state={user:null,tasks:[],withdrawals:[],referrals:[]};
let miningInterval=null;

function $(id){return document.getElementById(id);}
function saveState(){localStorage.setItem('dm_demo_state',JSON.stringify(state));}
function loadState(){
  const raw=localStorage.getItem('dm_demo_state');
  if(raw)state=JSON.parse(raw);
  if(!state.user){
    const urlParams=new URLSearchParams(location.search);
    const ref=urlParams.get('ref');
    state.user={id:'user_'+Math.floor(Math.random()*100000),coins:0,completedTasks:[],miningStart:null};
    if(ref){state.referrals.push(ref);}
  }
  state.tasks=state.tasks||[];
  state.withdrawals=state.withdrawals||[];
  state.referrals=state.referrals||[];
  saveState();
}

function updateUI(){
  $('coinBalance').innerText=`üí∞ ${Math.floor(state.user.coins)}`;
  $('userId').innerText='ID: '+state.user.id;
  $('profileUserId').innerText=state.user.id;
  $('profileCoins').innerText=Math.floor(state.user.coins);
  $('profileCompleted').innerText=state.user.completedTasks.length;
  $('refLink').value=location.origin+location.pathname+'?ref='+state.user.id;
  $('refInfo').innerText=state.referrals.length?`Total Referrals: ${state.referrals.length}`:'No referrals yet.';
  renderTasks();renderWithdrawals();renderAdminTasks();
  resumeMining();
}

document.querySelectorAll('.nav button').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function switchTab(tab){document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));$(tab).classList.remove('hidden');}

// ‚úÖ Task System ‚Äî Redirect + Reward
function renderTasks(){
  const el=$('taskList');el.innerHTML='';
  state.tasks.forEach((t,i)=>{
    const done=state.user.completedTasks.includes(i);
    const div=document.createElement('div');div.className='task-item';
    div.innerHTML=`<div><strong>${t.title}</strong><div class="muted">${t.reward} üí∞</div></div>`;
    const btn=document.createElement('button');
    btn.innerText=done?'‚úÖ Done':'Complete';
    btn.disabled=done;
    btn.onclick=()=>handleTask(i);
    div.appendChild(btn);
    el.appendChild(div);
  });
}

function handleTask(i){
  const t=state.tasks[i];
  if(state.user.completedTasks.includes(i))return;
  if(t.link){
    window.open(t.link, '_blank'); // open new page
  }
  setTimeout(()=>{
    state.user.completedTasks.push(i);
    state.user.coins+=t.reward;
    saveState();updateUI();
    alert(`+${t.reward} coins added`);
  },2000);
}

// ‚úÖ Mining System (Fixed)
function startMining(){
  if(state.user.miningStart){
    alert("Mining already running...");
    return;
  }
  state.user.miningStart=Date.now();
  saveState();
  $('farmStatus').innerText='‚õè Mining started...';
  $('farmButton').disabled=true;
  runMiningProgress();
}
function runMiningProgress(){
  clearInterval(miningInterval);
  miningInterval=setInterval(()=>{
    const elapsed=Date.now()-state.user.miningStart;
    const duration=DEFAULTS.farmingDurationMs;
    const p=Math.min((elapsed/duration)*100,100);
    $('farmProgress').style.width=p+'%';
    const remaining=Math.max(0,duration-elapsed);
    $('farmTimer').innerText=`Time left: ${(remaining/3600000).toFixed(2)} hrs`;
    if(elapsed>=duration){
      clearInterval(miningInterval);
      const earned=DEFAULTS.farmRate*60*24;
      state.user.coins+=earned;
      state.user.miningStart=null;
      $('farmButton').disabled=false;
      $('farmStatus').innerText='‚úÖ Mining complete';
      $('farmTimer').innerText='You earned '+earned+' coins!';
      saveState();updateUI();
    }
  },1000);
}
function resumeMining(){
  if(state.user.miningStart){
    const elapsed=Date.now()-state.user.miningStart;
    const duration=DEFAULTS.farmingDurationMs;
    if(elapsed<duration){
      $('farmStatus').innerText='‚õè Mining resumed...';
      $('farmButton').disabled=true;
      runMiningProgress();
    } else {
      state.user.miningStart=null;
      saveState();
    }
  }
}
$('farmButton').onclick=startMining;

// ‚úÖ Convert, Withdraw, Admin
function convertCoins(){
  const amt=parseFloat($('convertAmount').value);
  if(!amt||amt<=0)return alert('Enter amount');
  if(amt>state.user.coins)return alert('Not enough coins');
  const usd=amt*DEFAULTS.coinToUsd;
  $('convertedResult').innerText=`‚âà ${usd.toFixed(2)} USD`;
}

function requestWithdraw(){
  const amt=parseFloat($('withdrawAmount').value);
  const addr=$('withdrawAddress').value.trim();
  const m=$('withdrawMethod').value;
  if(!amt||!addr)return alert('Fill all fields');
  state.withdrawals.push({amount:amt,method:m,address:addr,status:'Pending'});
  saveState();updateUI();alert('Withdraw requested');
}
function renderWithdrawals(){
  const list=$('withdrawList'),adminList=$('adminWithdrawList');
  if(!state.withdrawals.length){
    list.innerText='No history';adminList.innerText='No withdrawals yet.';return;
  }
  let htmlUser='<table><tr><th>Amount</th><th>Method</th><th>Status</th></tr>';
  let htmlAdmin='<table><tr><th>Amount</th><th>Address</th><th>Method</th><th>Status</th><th>Action</th></tr>';
  state.withdrawals.forEach((w,i)=>{
    htmlUser+=`<tr><td>${w.amount}</td><td>${w.method}</td><td>${w.status}</td></tr>`;
    htmlAdmin+=`<tr><td>${w.amount}</td><td>${w.address}</td><td>${w.method}</td><td>${w.status}</td>
    <td><button class="small" onclick="updateWithdraw(${i},'Approved')">‚úÖ</button>
    <button class="small" style="background:#f44336" onclick="updateWithdraw(${i},'Rejected')">‚ùå</button></td></tr>`;
  });
  htmlUser+='</table>';htmlAdmin+='</table>';
  list.innerHTML=htmlUser;adminList.innerHTML=htmlAdmin;
}
function updateWithdraw(i,status){
  state.withdrawals[i].status=status;saveState();updateUI();alert('Withdraw '+status);
}

function adminLogin(){
  if($('adminEmail').value===ADMIN.email && $('adminPass').value===ADMIN.pass){
    $('adminPanel').classList.remove('hidden');updateUI();
  } else alert('Invalid login');
}
function addTask(){
  const t=$('taskTitle').value.trim(),r=parseInt($('taskReward').value),l=$('taskLink').value.trim();
  if(!t||!r)return alert('Fill task info');
  state.tasks.push({title:t,reward:r,link:l});
  $('taskTitle').value='';$('taskReward').value='';$('taskLink').value='';
  saveState();updateUI();
}
function renderAdminTasks(){
  const el=$('adminTaskList');
  if(!state.tasks.length){el.innerHTML='<div class="muted">No tasks yet</div>';return;}
  let html='<table><tr><th>Task</th><th>Reward</th><th>Link</th></tr>';
  state.tasks.forEach(t=>{html+=`<tr><td>${t.title}</td><td>${t.reward}</td><td>${t.link||'-'}</td></tr>`;});
  html+='</table>';el.innerHTML=html;
}

function copyRef(){navigator.clipboard.writeText($('refLink').value);alert('Referral link copied!');}

loadState();updateUI();
</script>
</body>
</html>
